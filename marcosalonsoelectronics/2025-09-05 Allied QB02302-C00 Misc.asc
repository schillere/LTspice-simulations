Version 4.1
SHEET 1 4328 3540
WIRE -608 -416 -640 -416
WIRE -368 -416 -608 -416
WIRE -96 -416 -368 -416
WIRE 160 -416 -96 -416
WIRE -368 -352 -368 -416
WIRE -288 -352 -368 -352
WIRE -96 -352 -96 -416
WIRE -16 -352 -96 -352
WIRE 160 -352 160 -416
WIRE 240 -352 160 -352
WIRE -288 -336 -288 -352
WIRE -16 -336 -16 -352
WIRE 240 -336 240 -352
WIRE -416 -304 -448 -304
WIRE -144 -304 -176 -304
WIRE 112 -304 80 -304
WIRE -288 -256 -288 -272
WIRE -288 -256 -368 -256
WIRE -16 -256 -16 -272
WIRE -16 -256 -96 -256
WIRE 240 -256 240 -272
WIRE 240 -256 160 -256
WIRE 1200 -256 1008 -256
WIRE 1232 -256 1200 -256
WIRE -368 -224 -368 -256
WIRE -320 -224 -368 -224
WIRE -224 -224 -320 -224
WIRE 656 -224 -192 -224
WIRE 1200 -224 1008 -224
WIRE 1232 -224 1200 -224
WIRE 656 -176 512 -176
WIRE 1200 -176 1008 -176
WIRE 1344 -176 1200 -176
WIRE 1472 -176 1408 -176
WIRE -640 -144 -640 -416
WIRE -240 -144 -272 -144
WIRE -208 -144 -208 -208
WIRE -208 -144 -240 -144
WIRE 656 -128 576 -128
WIRE 1120 -128 1008 -128
WIRE 1200 -128 1120 -128
WIRE 1232 -128 1200 -128
WIRE -96 -96 -96 -256
WIRE -16 -96 -96 -96
WIRE 64 -96 -16 -96
WIRE 512 -96 512 -176
WIRE 512 -96 96 -96
WIRE 1200 -96 1008 -96
WIRE 1232 -96 1200 -96
WIRE 656 -80 624 -80
WIRE 48 -48 16 -48
WIRE 80 -48 80 -80
WIRE 80 -48 48 -48
WIRE 736 -16 736 -64
WIRE 768 -16 768 -64
WIRE 800 -16 800 -64
WIRE 736 0 736 -16
WIRE 768 0 768 -16
WIRE 800 0 800 -16
WIRE 160 32 160 -256
WIRE 272 32 160 32
WIRE 368 32 272 32
WIRE 576 32 576 -128
WIRE 576 32 400 32
WIRE 1120 32 1120 -128
WIRE 1312 32 1120 32
WIRE 1584 48 1392 48
WIRE 1664 48 1584 48
WIRE -368 64 -368 -224
WIRE -288 64 -368 64
WIRE -96 64 -96 -96
WIRE -32 64 -96 64
WIRE 160 64 160 32
WIRE 224 64 160 64
WIRE 1232 64 1232 -96
WIRE 1312 64 1232 64
WIRE -288 80 -288 64
WIRE -32 80 -32 64
WIRE 224 80 224 64
WIRE 352 80 304 80
WIRE 384 80 384 48
WIRE 384 80 352 80
WIRE 624 80 624 -80
WIRE 1200 80 624 80
WIRE -416 112 -448 112
WIRE -144 112 -176 112
WIRE 112 112 80 112
WIRE 1200 144 1200 80
WIRE 1312 144 1200 144
WIRE -288 160 -288 144
WIRE -288 160 -368 160
WIRE -32 160 -32 144
WIRE -32 160 -96 160
WIRE 224 160 224 144
WIRE 224 160 160 160
WIRE 352 160 304 160
WIRE 624 160 624 80
WIRE 624 160 432 160
WIRE 1584 160 1392 160
WIRE 1664 160 1584 160
WIRE 1120 176 1120 32
WIRE 1312 176 1120 176
WIRE 720 208 688 208
WIRE 752 208 720 208
WIRE 688 224 688 208
WIRE -640 240 -640 -64
WIRE -368 240 -368 160
WIRE -368 240 -640 240
WIRE -96 240 -96 160
WIRE -96 240 -368 240
WIRE 160 240 160 160
WIRE 160 240 -96 240
WIRE 688 256 608 256
WIRE 720 256 720 208
WIRE 752 256 752 208
WIRE 848 256 848 -64
WIRE 880 256 880 -64
WIRE 912 256 912 -64
WIRE -96 304 -96 240
WIRE 224 432 -288 432
WIRE 304 432 304 160
WIRE 304 432 224 432
WIRE 512 464 432 464
WIRE 848 464 848 448
WIRE 848 464 576 464
WIRE -288 480 -288 432
WIRE 720 480 720 448
WIRE 720 480 576 480
WIRE 416 544 288 544
WIRE 224 560 128 560
WIRE 320 560 288 560
WIRE 416 560 416 544
WIRE 512 560 416 560
WIRE 880 560 880 448
WIRE 880 560 576 560
WIRE 752 576 752 448
WIRE 752 576 576 576
WIRE 512 656 432 656
WIRE 912 656 912 448
WIRE 912 656 576 656
WIRE 880 672 880 560
WIRE 880 672 576 672
WIRE 1472 672 1472 -176
WIRE 1616 672 1472 672
WIRE -288 736 -288 560
WIRE 416 736 288 736
WIRE 224 752 128 752
WIRE 320 752 320 560
WIRE 320 752 288 752
WIRE 416 752 416 736
WIRE 512 752 416 752
WIRE 720 752 720 480
WIRE 720 752 576 752
WIRE 688 768 688 448
WIRE 688 768 576 768
WIRE 512 848 432 848
WIRE 752 848 752 576
WIRE 752 848 576 848
WIRE 688 864 688 768
WIRE 688 864 576 864
WIRE 416 928 288 928
WIRE 224 944 128 944
WIRE 320 944 320 752
WIRE 320 944 288 944
WIRE 416 944 416 928
WIRE 512 944 416 944
WIRE 912 944 912 656
WIRE 912 944 576 944
WIRE 848 960 848 464
WIRE 848 960 576 960
WIRE 688 1008 688 864
WIRE 720 1008 720 752
WIRE 752 1008 752 848
WIRE 784 1008 784 448
WIRE 816 1008 816 448
WIRE 848 1008 848 960
WIRE 880 1008 880 672
WIRE 912 1008 912 944
WIRE 608 1120 480 1120
WIRE 656 1120 608 1120
WIRE 320 1136 320 944
WIRE 384 1136 320 1136
WIRE 416 1136 384 1136
WIRE 544 1152 480 1152
WIRE 576 1152 544 1152
WIRE 576 1344 576 1152
WIRE 608 1344 576 1344
WIRE 1040 1344 672 1344
WIRE -208 1392 -512 1392
WIRE -112 1392 -208 1392
WIRE 96 1392 -48 1392
WIRE -64 1952 -224 1952
WIRE 16 1952 -64 1952
WIRE -224 1984 -224 1952
WIRE -64 1984 -64 1952
WIRE -272 2000 -336 2000
WIRE -272 2096 -272 2048
WIRE -224 2096 -224 2064
WIRE -224 2096 -272 2096
WIRE -64 2096 -64 2064
WIRE -64 2096 -224 2096
WIRE -224 2128 -224 2096
WIRE -112 2256 -224 2256
WIRE -16 2256 -112 2256
WIRE 32 2256 -16 2256
WIRE 192 2256 144 2256
WIRE 1040 2256 1040 1344
WIRE 1040 2256 192 2256
WIRE 144 2272 144 2256
WIRE -512 2288 -512 1392
WIRE -224 2288 -224 2256
WIRE -112 2288 -112 2256
WIRE -16 2288 -16 2256
WIRE -560 2304 -832 2304
WIRE -448 2304 -512 2304
WIRE -336 2304 -336 2000
WIRE -336 2304 -448 2304
WIRE -272 2304 -336 2304
WIRE -512 2336 -512 2304
WIRE -560 2352 -560 2304
WIRE 144 2384 144 2352
WIRE -272 2400 -272 2352
WIRE -224 2400 -224 2368
WIRE -224 2400 -272 2400
WIRE -112 2400 -112 2352
WIRE -112 2400 -224 2400
WIRE -16 2400 -16 2368
WIRE -16 2400 -112 2400
WIRE -224 2432 -224 2400
WIRE -512 2464 -512 2416
WIRE -832 2480 -832 2304
WIRE -48 2560 -224 2560
WIRE 32 2560 -48 2560
WIRE -224 2592 -224 2560
WIRE -48 2592 -48 2560
WIRE -832 2608 -832 2560
WIRE -336 2608 -336 2304
WIRE -272 2608 -336 2608
WIRE -272 2704 -272 2656
WIRE -224 2704 -224 2672
WIRE -224 2704 -272 2704
WIRE -48 2704 -48 2672
WIRE -48 2704 -224 2704
WIRE -224 2720 -224 2704
WIRE -560 2784 -560 2400
WIRE 624 2784 -560 2784
WIRE 688 2784 624 2784
WIRE 768 2784 688 2784
WIRE 960 2784 848 2784
WIRE 1472 2784 1472 672
WIRE 1472 2784 960 2784
WIRE 688 2816 688 2784
WIRE 688 2912 688 2880
FLAG -96 304 0
FLAG 688 224 0
FLAG -320 -224 Pha
FLAG -16 -96 Phb
FLAG 272 32 Phc
FLAG 1200 -256 nr
FLAG 1200 -176 wrpm
FLAG 1200 -224 thetarot
FLAG -240 -144 ia
FLAG 1200 -128 w
FLAG 1200 -96 Te
FLAG 432 464 g0
IOPIN 432 464 Out
FLAG 128 560 g1
IOPIN 128 560 Out
FLAG 432 656 g2
IOPIN 432 656 Out
FLAG 128 752 g3
IOPIN 128 752 Out
FLAG 432 848 g4
IOPIN 432 848 Out
FLAG 128 944 g5
IOPIN 128 944 Out
FLAG -448 112 g0
IOPIN -448 112 In
FLAG -448 -304 g1
IOPIN -448 -304 In
FLAG -176 -304 g3
IOPIN -176 -304 In
FLAG 80 -304 g5
IOPIN 80 -304 In
FLAG -176 112 g2
IOPIN -176 112 In
FLAG 80 112 g4
IOPIN 80 112 In
FLAG 224 432 Tload
FLAG 48 -48 ib
FLAG 352 80 ic
FLAG 384 1136 pwm
FLAG 1616 672 sens
FLAG 544 1152 comp
FLAG 608 1120 tri
FLAG -288 736 0
FLAG -832 2608 0
FLAG -208 1392 target_diff
FLAG 736 -16 ea
FLAG 768 -16 eb
FLAG 800 -16 ec
FLAG -512 2464 0
FLAG -448 2304 2
FLAG 624 2784 12
FLAG 32 2256 4
FLAG -224 2432 0
FLAG 32 2560 5
FLAG -224 2720 0
FLAG 16 1952 3
FLAG -224 2128 0
FLAG 144 2384 0
FLAG 688 2912 0
FLAG 960 2784 11
FLAG 192 2256 6
FLAG 1584 48 Power_elec
FLAG -608 -416 dc
FLAG 1584 160 Power_mech
SYMBOL Control\\switch -368 -304 R0
WINDOW 0 -62 -39 Left 2
SYMATTR InstName Us1
SYMBOL Control\\switch -368 112 R0
WINDOW 0 -69 -36 Left 2
SYMATTR InstName Us0
SYMBOL Control\\switch -96 -304 R0
WINDOW 0 -59 -46 Left 2
SYMATTR InstName Us3
SYMBOL Control\\switch -96 112 R0
WINDOW 0 -65 -43 Left 2
SYMATTR InstName Us2
SYMBOL Control\\switch 160 -304 R0
WINDOW 0 -66 -45 Left 2
SYMATTR InstName Us5
SYMBOL Control\\switch 160 112 R0
WINDOW 0 -67 -50 Left 2
SYMATTR InstName Us4
SYMBOL voltage -640 -160 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName Vdc
SYMATTR Value {DC_bus_voltage}
SYMBOL 74HC\\74hc138 976 352 R90
SYMATTR InstName U5
SYMBOL Control\\constant 576 256 R0
WINDOW 3 -5 68 Bottom 2
WINDOW 0 -15 -42 Bottom 2
SYMATTR Value K=5
SYMATTR InstName U3
SYMBOL Digital\\and 544 544 R180
WINDOW 0 3 109 Left 2
SYMATTR InstName A0
SYMBOL Digital\\and 544 640 R180
WINDOW 0 -2 115 Left 2
SYMATTR InstName A1
SYMBOL Control\\idiode -272 -272 R180
SYMATTR InstName Ud1
SYMBOL Control\\idiode -272 144 R180
SYMATTR InstName Ud0
SYMBOL Control\\idiode -16 144 R180
SYMATTR InstName Ud2
SYMBOL Control\\idiode 0 -272 R180
SYMATTR InstName Ud3
SYMBOL Control\\idiode 256 -272 R180
SYMATTR InstName Ud5
SYMBOL Control\\idiode 240 144 R180
SYMATTR InstName Ud4
SYMBOL BLDCM\\bldcm 800 -176 R0
WINDOW 3 6 -192 Bottom 2
WINDOW 123 4 -160 Bottom 2
WINDOW 39 28 -125 Bottom 2
WINDOW 0 -69 -78 Bottom 2
WINDOW 38 86 -81 Bottom 2
SYMATTR Value R=1.99 L=1.84e-3 M=0
SYMATTR Value2 npp=3 Kv=.0799
SYMATTR SpiceLine To=0 J=2.2e-5 Bv=0.00022
SYMATTR InstName U2
SYMBOL Control\\isense -208 -224 R0
WINDOW 0 28 -13 Bottom 2
WINDOW 3 32 36 Bottom 2
SYMATTR InstName U1
SYMBOL Digital\\and 544 736 R180
WINDOW 0 -2 115 Left 2
SYMATTR InstName A2
SYMBOL Digital\\and 544 832 R180
WINDOW 0 -2 115 Left 2
SYMATTR InstName A3
SYMBOL Digital\\and 544 928 R180
WINDOW 0 -2 115 Left 2
SYMATTR InstName A4
SYMBOL Digital\\and 544 1024 R180
WINDOW 0 -2 115 Left 2
SYMATTR InstName A5
SYMBOL Control\\isense 80 -96 R0
WINDOW 0 28 -13 Bottom 2
WINDOW 3 32 36 Bottom 2
SYMATTR InstName U6
SYMBOL Control\\isense 384 32 R0
WINDOW 0 28 -13 Bottom 2
WINDOW 3 32 36 Bottom 2
SYMATTR InstName U7
SYMBOL Control\\sawtooth 688 1120 M0
WINDOW 3 -139 -5 Bottom 2
WINDOW 123 -91 32 Bottom 2
SYMATTR Value2 f=10k
SYMATTR InstName U9
SYMBOL Control\\comp 448 1136 R180
WINDOW 3 25 -53 Left 2
WINDOW 123 25 -81 Left 2
SYMATTR Value Vhigh=1
SYMATTR Value2 Vlow=0
SYMATTR InstName U10
SYMBOL Digital\\and 256 608 R180
WINDOW 0 3 109 Left 2
SYMATTR InstName A6
SYMBOL Digital\\and 256 800 R180
WINDOW 0 3 109 Left 2
SYMATTR InstName A7
SYMBOL Digital\\and 256 992 R180
WINDOW 0 3 109 Left 2
SYMATTR InstName A8
SYMBOL Control\\limiter 640 1344 M0
WINDOW 0 56 39 Bottom 2
WINDOW 38 -22 -37 Bottom 2
WINDOW 3 -10 69 Bottom 2
WINDOW 123 3 97 Bottom 2
SYMATTR InstName U13
SYMATTR Value vth=0.99
SYMBOL res 448 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R3
SYMATTR Value 1
SYMBOL voltage -288 464 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 0 45 32 Left 2
WINDOW 3 36 72 Left 2
SYMATTR InstName Tload1
SYMATTR Value {Rated_Torque}
SYMBOL voltage -832 2464 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
WINDOW 0 45 32 Left 2
WINDOW 3 36 68 Left 2
SYMATTR InstName SpeedTarget
SYMATTR Value {SpeedTarget}
SYMBOL Control\\gain 1376 -176 R0
WINDOW 3 3 71 Bottom 2
SYMATTR Value A=1e-3
SYMATTR InstName U8
SYMBOL e -512 2320 R0
WINDOW 0 25 20 Left 2
WINDOW 3 26 91 Left 2
SYMATTR InstName EERROR1
SYMATTR Value 1.0
SYMBOL cap -128 2288 R0
SYMATTR InstName C1
SYMATTR Value 1
SYMBOL ind -64 2576 R0
SYMATTR InstName L1
SYMATTR Value 1
SYMBOL bv 144 2256 R0
WINDOW 3 -58 186 Left 2
WINDOW 0 33 37 Left 2
SYMATTR Value V=(  Kp*v(3) + Ki*v(4)  + Kd*v(5)  )
SYMATTR InstName BPID1
SYMBOL res -32 2272 R0
SYMATTR InstName R1
SYMATTR Value 1e6
SYMBOL res 752 2768 M90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName RP3
SYMATTR Value 1k
SYMBOL cap 704 2816 M0
SYMATTR InstName CP2
SYMATTR Value 1µF
SYMBOL e -224 1968 R0
SYMATTR InstName EP1
SYMATTR Value 1.0
SYMBOL g -224 2272 R0
SYMATTR InstName GI1
SYMATTR Value 1.0
SYMBOL g -224 2576 R0
SYMATTR InstName GD1
SYMATTR Value 1.0
SYMBOL res -80 1968 R0
SYMATTR InstName RP4
SYMATTR Value 1e6
SYMBOL marcosalonsoelectronics\\Control\\pid_comp -80 1392 R0
WINDOW 3 8 59 Bottom 2
WINDOW 123 27 86 Bottom 2
WINDOW 39 27 112 Bottom 2
SYMATTR Value k={Kp}
SYMATTR Value2 tau_i=1/{Ki}
SYMATTR SpiceLine tau_d={Kd}
SYMATTR InstName U12
SYMBOL Control\\mul 1344 48 R0
SYMATTR InstName U4
SYMBOL Control\\mul 1344 160 R0
SYMATTR InstName U11
TEXT 344 -376 Left 2 !.tran 0 100m 20m uic
TEXT 960 368 Left 2 !.inc 74HC.lib
TEXT 344 -344 Left 2 !.options reltol=1
TEXT 744 360 Left 2 ;74HC138
TEXT 2072 -488 Left 2 ;Allied Motion Quantum NEMA 23\nQB02302-C00\nhttps://allient.com/d/?h=e4564e2#docs&src=https://undefined\n2025-09-03 Allient-Brushless-DC-Motors-Quantum-NEMA-Series-23-11212024.pdf\n \nDelta winding, which does NOT match the LTspice model\n \nIteratively found that Kv = .0799, when run with a range of torques...\nthen plotted Te_rms versus ia_rms so that the slope is the Torque Constant and matches the 0.198 Nm/A from the datasheet.\n(do not currently have a theoretical basis for this value...perhaps because the model is based on a WYE winding?)\niterated with duty cycle hard wired to 100% \n \nLTspice model\nhttps://www.youtube.com/watch?v=i4hok5Mow5U&t=1014s minute 6:20 shows units\nhttps://www.youtube.com/watch?v=UEygOGviE2k\nhttps://github.com/marcosalonsoelectronics\n \nKv = phase back-emf coefficient (V/rad/s) --> Va = Kv * w\nVA is the amplitude of the back-emf trapezoidal output in each phase\nline back-emfs --> eab, ebc, eca, their amplitude is twice that of phase back-emf\n \nR = series resitance, phase resistance (NOT line-to-line terminal resistance)\nFor a dc motor measure the resistance between the 2 armature wires.\nIf it is a WYE connected BLDC motor, the resistance is the line-to-line resistance. Thus divide the resistance (l-l) by 2 to get the phase resistance.\nFor a DELTA winding terminal resistance should equal phase resistance directly.\n \nL = self inductance of windings (NOT line-to-line terminal inductance)\nLike resistance, for a WYE winding the phase L used in this model should be half of the line-to-line value reported on the datasheet\nFor a DELTA winding terminal inductance should equal phase resistance directly.\n \nBv = viscous fricton coefficient (kg m^2/s)\nTo = no load torque\nnpp = number of pole pairs\nSince there is no datasheet item for Bv, after setting R & L from the datasheet and iteratively finding Kv, I set load to 0.57Nm (rated torque) then\nadjusted Bv until steady state speed matched the rated speed (~5550 rpm) and the RMS value for phase current (ia, ib, or ic) matched the data sheet's rated phase current value (~3.6Arms)\niterated with duty cycle hard wired to 100%\n \nM = mutual inductance of the windings\n \ntheta (radians)\nJ = moment of inertia (kg m^2)\nnr = total number of rotor revolutions\ntheta = rotation angle (rad)\nw = output speed (rad/s)\nf = pwm frequency (Hz)\nea, eb, ec = back emf\nha, hb, hc = hall sensor outputs (between 0 and 5V)\n \ntau_e (ms) = circuit inductance (mH) / circuit resistance (Ohms)\n \nTe = electromagnetic torque (Nm)
TEXT 1056 288 Left 2 ;decoder to do the driving
TEXT 432 128 Left 0 ;added to improved convergence but doesn't have significant effect on results\nhttps://www.youtube.com/watch?v=Pc76zFAWCsE&t=928s (22:54)
TEXT 968 1096 Left 2 ;sawtooth waveform generator
TEXT 664 -824 Left 2 !.measure wrpm_avg avg V(wrpm)\n.measure Te_avg avg V(Te)\n.measure Te_rms rms V(Te)\n.measure ia_rms rms V(ia)\n \n.measure w_avg avg V(w)\n.measure Pin avg V(dc)*(-I(Vdc))\n.measure Pout param Rated_Torque*w_avg\n.measure Eff param Pout*100/Pin
TEXT -200 568 Left 2 ;Nm
TEXT -736 2576 Left 2 ;rpm/1000
TEXT 1488 -232 Left 2 ;assume gain of tachometer is .001 V/rpm\n(small number seems to help with convergence)
TEXT 1504 -400 Left 2 !.param Rated_Torque=0.57
TEXT 1120 2720 Right 2 ;SENSOR
TEXT -160 2208 Left 2 ;INTEGRATOR
TEXT -152 2512 Left 2 ;DIFFERENTIATOR
TEXT -176 1912 Left 2 ;PROPORTIONAL
TEXT -192 1784 Left 2 !.param Kp=2\n.param Ki=40\n.param Kd=0.001
TEXT -704 2216 Left 2 ;SET POINT
TEXT -480 2216 Left 2 ;ERROR
TEXT 584 2712 Left 2 ;SENSOR TIME-LAG
TEXT 104 2208 Left 2 ;PID SUM
TEXT -336 1664 Left 2 !.param SpeedTarget = 5
TEXT 1504 -360 Left 2 ;.step param Rated_Torque 0 1 .1
TEXT 1496 -480 Left 2 !.param DC_bus_voltage=130
TEXT 624 1248 Left 2 ;1 is 100% duty cycle (99%), 0.5 is 50% duty cycle, 0 is 0% duty cycle
TEXT -1168 1752 Left 2 ;.step param Kd 0 .005 .0002
TEXT -848 1312 Left 2 ;alternative approach would be to use the pid component from marcosalonsoelectronics
TEXT -384 1744 Left 2 ;pid component from eCircuitCenter
TEXT 744 1312 Left 2 ;to ensure value always falls within the sawtooth waveform
TEXT 776 2888 Left 2 ;RC circuit low-pass filter\nthese values have cutoff frequency of ~160Hz\nlower frequencies pass unimpeded\ndon't need to feed a bunch of ripple back into the PID controller\nchanging this filter requires readjusting the PID gains
TEXT 0 1664 Left 2 ;rpm/1000
TEXT 2000 -680 Left 2 ;efficiency = Pout / Pin\nPout = Tload * w\nPin = Vdc * Idc
TEXT 2000 -752 Left 2 ;Pin calculations are messy with PID and PWM speed control active\nIf need efficiency measures, remove the PID and PWM stuff
RECTANGLE Normal 240 2752 -384 1888 1
