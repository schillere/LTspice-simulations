Version 4
SHEET 1 2740 1220
WIRE -304 -416 -352 -416
WIRE -208 -416 -304 -416
WIRE -48 -416 -128 -416
WIRE -304 -384 -352 -384
WIRE -304 -352 -352 -352
WIRE -176 -352 -176 -384
WIRE -176 -336 -176 -352
WIRE -368 -304 -368 -336
WIRE -352 -304 -368 -304
WIRE -432 -272 -432 -336
WIRE -352 -272 -432 -272
WIRE 1104 -32 992 -32
WIRE 2496 -16 2432 -16
WIRE 2624 -16 2560 -16
WIRE 992 48 992 -32
WIRE -144 80 -192 80
WIRE 112 80 -144 80
WIRE 288 80 224 80
WIRE 496 80 288 80
WIRE 608 80 576 80
WIRE 784 80 608 80
WIRE 960 80 864 80
WIRE 1200 80 1040 80
WIRE 1456 80 1280 80
WIRE 1760 80 1568 80
WIRE 2000 80 1856 80
WIRE 2112 80 2080 80
WIRE 2128 80 2112 80
WIRE 2208 80 2128 80
WIRE 2432 80 2432 -16
WIRE 2432 80 2272 80
WIRE 2624 80 2432 80
WIRE -144 112 -192 112
WIRE 112 112 -144 112
WIRE 288 112 224 112
WIRE 336 112 288 112
WIRE 608 112 608 80
WIRE 640 112 608 112
WIRE 528 128 528 112
WIRE 528 128 432 128
WIRE 816 128 816 112
WIRE 816 128 704 128
WIRE -144 144 -192 144
WIRE 112 144 -144 144
WIRE 528 144 528 128
WIRE 640 144 608 144
WIRE 816 144 816 128
WIRE 1488 160 1488 112
WIRE 2032 160 2032 112
WIRE -368 176 -400 176
WIRE -272 176 -272 160
WIRE -272 176 -368 176
WIRE 336 176 336 112
WIRE 496 176 336 176
WIRE 608 176 608 144
WIRE 608 176 576 176
WIRE 784 176 608 176
WIRE 960 176 864 176
WIRE 1232 176 1232 112
WIRE 1232 176 1040 176
WIRE 2432 176 2432 80
WIRE 2496 176 2432 176
WIRE 2592 176 2560 176
WIRE 2624 176 2592 176
WIRE 432 192 432 128
WIRE -368 208 -368 176
WIRE -336 208 -368 208
WIRE -240 208 -240 160
WIRE -240 208 -288 208
WIRE -144 208 -240 208
WIRE -368 240 -368 208
WIRE -144 240 -368 240
WIRE 2240 256 2240 112
WIRE 2352 256 2240 256
WIRE 2592 256 2592 176
WIRE 2592 256 2416 256
WIRE -208 272 -208 160
WIRE -144 272 -208 272
WIRE 992 272 992 208
WIRE 1056 272 992 272
WIRE 1488 272 1488 208
WIRE 2128 272 2128 80
WIRE 2128 272 1488 272
WIRE -208 288 -208 272
FLAG -144 208 amplitude
IOPIN -144 208 Out
FLAG -144 240 frequency
IOPIN -144 240 Out
FLAG -288 112 0
FLAG -144 80 a
FLAG -144 112 b
FLAG -144 144 c
FLAG 288 80 alpha
FLAG 288 112 beta
FLAG 432 272 0
FLAG 2032 240 0
FLAG -448 -384 0
FLAG -304 -416 a*
FLAG -304 -384 b*
FLAG -304 -352 c*
FLAG 2624 176 sin
IOPIN 2624 176 Out
FLAG 2624 -16 cos
IOPIN 2624 -16 Out
FLAG -176 -352 sin
FLAG -48 -416 test
IOPIN -48 -416 Out
FLAG 2112 80 LF
FLAG 2624 80 wt
IOPIN 2624 80 Out
FLAG -352 -272 frequency
IOPIN -352 -272 In
FLAG 1056 272 sin
IOPIN 1056 272 In
FLAG 1104 -32 cos
IOPIN 1104 -32 In
FLAG -208 368 0
FLAG -144 272 phase
IOPIN -144 272 Out
FLAG -352 -304 phase
IOPIN -352 -304 In
FLAG 1456 112 0
SYMBOL 3ph_gen -240 112 R0
SYMATTR InstName U1
SYMATTR SpiceLine h1=0 h2=0 h3=0 phi1=0 phi2=0.1 phi3=0
SYMATTR SpiceLine2 a=1 b=1/3 c=0 d=1/5 e=pi/5 p=2 q=1 xp=1.5 xq=1
SYMATTR Value2 dc1=0.1 dc2=0 dc3=0 A1=1.1 A2=1 A3=0.9
SYMATTR Value sym=0 f=0 amp=0 phi=0 Ro=1 N=13
SYMBOL Disturb -416 176 R0
SYMATTR SpiceLine A=f B={f/25} delay=0.5 sigma=0.35 xp=1
SYMATTR InstName U3
SYMATTR SpiceLine2 f=3 phi=pi/10 sq=1 skew=20
SYMBOL Gain -320 208 R0
WINDOW 39 16 15 Left 2
SYMATTR SpiceLine G=3/f
SYMATTR InstName U4
SYMBOL PID 1808 80 R0
WINDOW 39 -1 35 Center 2
WINDOW 0 -49 -37 Left 2
WINDOW 123 -53 68 Left 2
WINDOW 3 -10 100 Center 2
SYMATTR SpiceLine Kp={kp}
SYMATTR InstName U11
SYMATTR Value2 Ki={ki}
SYMBOL Integ_r 2240 80 R0
WINDOW 40 -3 -70 Center 2
SYMATTR SpiceLine2 edge=1
SYMATTR SpiceLine tau={1/(2*pi)}
SYMATTR InstName U12
SYMBOL Math1 2528 -16 R0
WINDOW 40 0 28 Center 2
SYMATTR SpiceModel cos
SYMATTR InstName U25
SYMBOL Math1 2528 176 R0
WINDOW 40 0 28 Center 2
SYMATTR SpiceModel sin
SYMATTR InstName U26
SYMBOL Transforms 160 112 R0
SYMATTR InstName U2
SYMBOL Math2r -176 -416 R0
SYMATTR InstName U5
SYMBOL Math2r 528 80 R0
SYMATTR SpiceModel x
SYMATTR InstName U6
SYMBOL Math2r 528 176 M180
SYMATTR SpiceModel x
SYMATTR InstName U7
SYMBOL Math2r 992 176 R0
SYMATTR SpiceModel x
SYMATTR InstName U8
SYMBOL Math2r 992 80 M180
SYMATTR SpiceModel x
SYMATTR InstName U9
SYMBOL Math2r 1232 80 R0
SYMATTR SpiceModel +
SYMATTR InstName U10
SYMBOL Math2r 2032 80 R0
SYMATTR SpiceModel +
SYMATTR InstName U13
SYMBOL voltage 432 176 R0
WINDOW 0 37 70 Left 2
SYMATTR InstName Vstart
SYMATTR Value pulse 0 1 23m 1u
SYMBOL voltage 2032 144 R0
SYMATTR InstName Vf
SYMATTR Value {f}
SYMBOL voltage -208 272 R0
WINDOW 0 25 97 Left 2
WINDOW 3 -28 127 Left 2
SYMATTR InstName Vphase
SYMATTR Value pulse 0 {-pi/2} 1234m 1u
SYMBOL 3ph_gen -400 -384 R0
SYMATTR InstName U14
SYMATTR SpiceLine2 a=1 b=0 c=0 d=0 e=0 p=1 q=0 xp=1.5 xq=1
SYMATTR Value sym=1 f=0 amp=1 phi=0 Ro=1 N=1
SYMBOL Filter 1520 80 R0
SYMATTR SpiceModel MAFv
SYMATTR SpiceLine2 G=1 Asc=0 Ap=1 As=40 N=1
SYMATTR SpiceLine f0=0 fp1=25 fs1=100 fp2=0 fs2=0
SYMATTR InstName U15
SYMBOL Gain 1488 192 R270
SYMATTR SpiceLine G=1
SYMATTR InstName U16
SYMBOL Digital\\buf1 2416 192 M0
WINDOW 3 23 84 Left 2
SYMATTR Value ref=0 td=10n
SYMATTR InstName A1
SYMBOL Math2r 816 80 R0
SYMATTR SpiceModel /
SYMATTR InstName U20
SYMBOL Math2 672 128 R0
SYMATTR SpiceModel hypot
SYMATTR InstName U18
SYMBOL Math2r 816 176 M180
SYMATTR SpiceModel /
SYMATTR InstName U17
TEXT 320 -160 Left 2 !.tran 0 2 0
TEXT 320 -232 Left 2 !.param f=50 kp=9 ki=20
TEXT 1928 312 Left 2 ;The fixed-frequency\nw0. (f not w so it\ncan be compared\nwith v(frequency))
TEXT 320 -192 Left 2 !.four {f} 25 v(sin)
TEXT 432 -408 Center 5 ;PQ PLL
TEXT -464 -40 Left 2 ;The grid side with polluted waveforms.\nThe three devices below induce a\ndisturbance in frequency, amplitude\nand phase.
TEXT 64 232 Left 2 ;The Clarke matrix. A\ncheaper version uses\nV(a)-V(b) and V(c)-V(b)\nas inputs, but then\nthere would have been\nneeded different/\nadditional sin/cos\ngenerators.
TEXT 400 328 Left 2 ;A small delayed\nstart to see the\nPLL's initial\nresponse.
TEXT -456 -184 Left 2 ;This part is for comparison, only. The generator\nis the "clean" version of the grid, unitiy amplitude,\nbut following its frequency/phase jumps, which is\ncompared with V(sin)  =>  V(test)
TEXT 928 -216 Left 3 ;The actual PLL
TEXT 944 368 Left 2 ;The phase detector
TEXT 1416 312 Left 2 ;An adaptive moving\naverage filter with\na time window of\nhalf the period.
TEXT 1712 400 Left 2 ;The loop-filter
TEXT 2168 336 Left 2 ;The VCO, a simple resettable integrator with\nsin/cos generators. Since the previous block\nhas the value "f", this one has "1/(2*pi)".
TEXT 936 -152 Left 2 ;Keep in mind that this is done inside\na DSP chip so this is a translation in\nanalog world of what happens digitally.
TEXT -456 368 Left 2 ;a step-change\nin phase
TEXT 560 16 Left 2 ;amplitude normalization
TEXT 320 -128 Left 2 !.save v(*)
RECTANGLE Normal 32 416 -480 -64 2
RECTANGLE Normal 368 416 48 -64 2
RECTANGLE Normal 896 416 384 -64 2
RECTANGLE Normal 2736 432 912 -256 1
RECTANGLE Normal 32 -80 -480 -464 2
RECTANGLE Normal 1312 416 928 -64 2
RECTANGLE Normal 1680 416 1328 -64 2
RECTANGLE Normal 1904 416 1696 -64 2
RECTANGLE Normal 2144 416 1920 -64 2
RECTANGLE Normal 2720 416 2160 -64 2
