Version 4
SHEET 1 4544 744
WIRE -816 -64 -880 -64
WIRE -800 -64 -816 -64
WIRE 464 -16 464 -32
WIRE -1024 0 -1120 0
WIRE -816 0 -880 0
WIRE -704 0 -816 0
WIRE -528 0 -624 0
WIRE -368 0 -448 0
WIRE -176 0 -272 0
WIRE -48 0 -128 0
WIRE 192 0 -48 0
WIRE 384 0 288 0
WIRE 592 0 512 0
WIRE 704 0 672 0
WIRE 768 0 704 0
WIRE 832 0 768 0
WIRE 1024 0 912 0
WIRE 1088 0 1024 0
WIRE 384 16 288 16
WIRE -496 48 -496 32
WIRE 1024 48 1024 0
WIRE 1504 48 1424 48
WIRE -48 64 -48 0
WIRE 48 64 -48 64
WIRE 192 64 96 64
WIRE 768 64 768 0
WIRE 384 96 288 96
WIRE 592 96 512 96
WIRE 384 112 288 112
WIRE 464 144 464 128
WIRE 592 144 592 96
WIRE 1024 208 1024 128
WIRE 1008 224 944 224
WIRE 768 240 768 128
WIRE -672 256 -672 32
WIRE -272 256 -672 256
WIRE -16 256 -192 256
WIRE 224 256 32 256
WIRE 752 256 224 256
WIRE -224 304 -224 288
WIRE -16 304 -224 304
WIRE 224 304 48 304
WIRE 400 304 224 304
WIRE 704 304 704 0
WIRE 704 304 464 304
WIRE 400 336 384 336
WIRE 768 336 768 304
WIRE 768 336 464 336
WIRE 1024 336 1024 272
WIRE 1024 336 768 336
WIRE 1072 336 1024 336
WIRE 384 368 384 336
WIRE 1072 384 1072 336
WIRE 480 560 480 432
WIRE 480 560 464 560
WIRE 496 560 480 560
WIRE 592 560 592 432
WIRE 592 560 576 560
FLAG 1088 0 out
IOPIN 1088 0 Out
FLAG 752 288 0
FLAG 592 432 V+
FLAG 400 560 0
FLAG 480 432 V-
FLAG 464 -32 V+
FLAG 464 144 V-
FLAG 384 368 0
FLAG 592 144 COM
FLAG 1072 384 COM
FLAG -816 0 ref
FLAG 224 256 Ic
FLAG 224 304 Vc
FLAG 944 224 FB
IOPIN 944 224 Out
FLAG 1008 256 0
FLAG -496 48 FB
IOPIN -496 48 In
FLAG -1120 80 0
FLAG -816 -64 sin
FLAG 1424 128 0
SYMBOL Math2r -672 0 R0
SYMATTR InstName U6
SYMBOL PID -320 0 R0
SYMATTR SpiceLine2 Ts=0.025m
SYMATTR InstName U8
SYMATTR SpiceLine Kp=6 Ki=12k
SYMBOL ind 576 16 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
WINDOW 39 -51 60 VTop 2
SYMATTR InstName Li
SYMATTR Value {Li}
SYMATTR SpiceLine Rser={Ri}
SYMBOL cap 752 64 R0
WINDOW 0 43 2 Left 2
WINDOW 3 41 30 Left 2
WINDOW 39 23 63 Left 2
SYMATTR InstName Cf
SYMATTR Value {Cf}
SYMATTR SpiceLine Rser={Rc}
SYMBOL ind 816 16 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
WINDOW 39 -51 60 VTop 2
SYMATTR InstName Lg
SYMATTR Value {Lg}
SYMATTR SpiceLine Rser={Rg}
SYMBOL Isense 768 272 R90
SYMATTR SpiceLine G={if(VI==1 | Rv==0,0,0.1)}
SYMATTR InstName U4
SYMBOL Math2r -496 0 R0
SYMATTR InstName U5
SYMBOL 3lvl_mod 240 48 R0
WINDOW 0 -79 -70 Left 2
WINDOW 123 -68 113 Left 2
SYMATTR InstName U1
SYMATTR Value2 td=1u vh=5m
SYMATTR SpiceLine2 Vpk=10 f=5k dt=1u
SYMBOL 3ph_br_vm 448 64 R0
SYMATTR SpiceLine Ron=100m Roff=10Meg Vfwd=1
SYMATTR InstName U2
SYMATTR SpiceLine2 Rs=10meg Cs=1n
SYMBOL Vsense 448 320 M0
SYMATTR SpiceLine G={if(VI==2 | Rv==0,0,0.1)}
SYMATTR InstName U9
SYMBOL Isense 1024 240 R90
SYMATTR SpiceLine G=0.1
SYMATTR InstName U11
SYMBOL cap 464 544 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C2
SYMATTR Value 1n
SYMATTR SpiceLine Rser=1 Rpar=1e6
SYMBOL ind2 1008 32 R0
WINDOW 39 43 105 Left 2
WINDOW 3 39 71 Left 2
SYMATTR SpiceLine Rser={Rs}
SYMATTR Value {Lm}
SYMATTR InstName Ls
SYMATTR Type ind
SYMBOL Gain 16 256 M0
WINDOW 39 15 -20 Left 2
SYMATTR SpiceLine G={1/Rv**u(Rv)}
SYMATTR InstName U3
SYMBOL Diff 16 304 M0
WINDOW 39 28 21 Left 2
SYMATTR SpiceLine tau={Rv**u(Rv)*Cf}
SYMATTR InstName U12
SYMBOL Math2r -224 256 M0
SYMATTR InstName U7
SYMATTR SpiceModel +
SYMBOL voltage 592 560 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 41 14 VTop 2
SYMATTR InstName V1
SYMATTR Value 750 Rser=0.1 Cpar=1m
SYMBOL SpecialFunctions\\modulate2 -1024 -64 R0
WINDOW 3 16 -24 Left 2
SYMATTR Value mark=50 space=0
SYMATTR InstName A1
SYMATTR Value2 vhigh=2.501 vlow=-2.501
SYMBOL voltage -1120 -16 R0
SYMATTR InstName V2
SYMATTR Value pulse 1 0.5 19.99m 20u 20u 20m 40m
SYMBOL Gain 64 64 R0
WINDOW 39 15 -20 Left 2
SYMATTR InstName U10
SYMBOL Lim -144 0 R0
SYMATTR SpiceLine Min=-10 Max=10
SYMATTR InstName U13
SYMBOL ind2 1440 32 M0
WINDOW 39 43 105 Left 2
WINDOW 3 39 71 Left 2
SYMATTR SpiceLine Rpar={Rs*0.5}
SYMATTR Value {Lm}
SYMATTR InstName Lr
SYMATTR Type ind
TEXT 1224 -216 Left 2 !.tran 60m
TEXT 1224 -144 Left 2 !.parma  Li=5.3m  Lg=0.3m  Cf=11u\n+  Ri=150m  Rg=50m  Rc=125m\n+  Lm=100m Rs=5\n+  VI=1\n+  Rv=0.7
TEXT 1656 -144 Left 2 ;Li, Lg, C - The LCL filter components.\nRi, Rg, Rc - The LCL parasitics.\nRload - The load.\nVI - <1> means voltage across capacitor Cf, <2> - current through it.\nRv - The virtual resistance. See different values (0 included) vs different\n     methods (VI=<1,2>) and also check the impact it has on the switching\n     frequency (the output of the PWM controller)
TEXT -736 368 Left 2 ;This part proccesses either the voltage across the capacitor C (VI=1), or the current\nthrough it (VI=2), to be differentiated or amplified, respectively, and then subtracted\nfrom the input signal.
TEXT -568 -288 Left 2 ;The feedback PI controller.
TEXT -72 -288 Left 2 ;The power play with the acronym\nSPWM. "td" and "vh" are there to\nminimize the effect of noise at the\ninput. "td" should have a value, but\n"vh" can be zero, at the cost of\npossible MHz switching frequency.\nSetting them, however, may mean\nlarger ripple and transients or distorted\nwaveforms.
TEXT 464 -288 Left 2 ;The LCL filter and the load, mimicking a simplified\nversion of a motor.
TEXT -24 -504 Left 4 ;Virtual Resistor Damping
TEXT 16 -464 Left 2 ;(a simple, one-phase version)
TEXT -952 224 Left 2 ;A cosine input\nreference for a\nbetter view of the\nstartup transient.\nAlso, an amplitude\nstep for a dynamic\nbehaviour response.
TEXT 1232 280 Left 2 ;.step param Rv list 0.65 0.95 0.1
TEXT 1216 48 Left 2 !k Ls Lr 0.95
LINE Normal 432 624 432 -328 3
LINE Normal -752 -312 -592 -312 1
LINE Normal -752 448 -752 -312 1
LINE Normal 416 448 -752 448 1
LINE Normal 416 192 416 448 1
LINE Normal -592 192 416 192 1
LINE Normal -592 -312 -592 192 1
LINE Normal 1024 -64 768 -64 2
LINE Normal 992 -48 1024 -64 2
LINE Normal 1024 -64 992 -80 2
RECTANGLE Normal -96 176 -576 -312 2
RECTANGLE Normal 416 176 -80 -312 2
RECTANGLE Normal 1184 448 448 -312 2
